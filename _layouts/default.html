<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} — {% endif %}{{ site.title }}</title>
  <meta name="description" content="{{ page.description | default: site.description }}">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400;1,6..72,500&family=JetBrains+Mono:wght@400;500&family=DM+Sans:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

  <!-- Stylesheet -->
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
</head>
<body>

  <nav class="site-nav">
    <a href="{{ site.baseurl }}/" class="site-title">{{ site.title }}</a>
    <ul class="site-nav-links">
      <li><a href="#" onclick="toggleLang(event)" id="lang-toggle">DE</a></li>
      <li>
        <a href="{{ site.baseurl }}/">
          <span class="lang-en">Courses</span>
          <span class="lang-de">Kurse</span>
        </a>
      </li>
      <li>
        <a href="{{ site.baseurl }}/about/">
          <span class="lang-en">About</span>
          <span class="lang-de">Über</span>
        </a>
      </li>
    </ul>
  </nav>

  <div class="page-wrapper">
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc-nav" id="toc-nav">
        <ul id="toc-list"></ul>
      </nav>
    </aside>

    <main class="container page-content">
      {{ content }}
    </main>
  </div>

  <footer class="site-footer">
    <p>&copy; {{ 'now' | date: '%Y' }} {{ site.title }}</p>
  </footer>

  <script>
    /* ---- Table of Contents ---- */
    function buildToc() {
      var tocList = document.getElementById('toc-list');
      var sidebar = document.getElementById('toc-sidebar');
      if (!tocList) return;

      // Clear existing ToC
      tocList.innerHTML = '';

      // Only pick up h2s that are currently visible (not hidden by language toggle)
      var allH2s = document.querySelectorAll('.page-content h2');
      var headings = [];
      allH2s.forEach(function(h) {
        if (h.offsetParent !== null && h.offsetHeight > 0) {
          headings.push(h);
        }
      });

      if (headings.length < 2) {
        sidebar.style.display = 'none';
        return;
      } else {
        sidebar.style.display = '';
      }

      headings.forEach(function(h, i) {
        if (!h.id) {
          h.id = h.textContent
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
        }

        var li = document.createElement('li');
        var a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent;
        li.appendChild(a);
        tocList.appendChild(li);
      });

      // Update active heading on scroll
      var tocLinks = tocList.querySelectorAll('a');

      function updateActive() {
        var scrollPos = window.scrollY + 120;
        var current = null;

        headings.forEach(function(h, i) {
          if (h.offsetTop <= scrollPos) {
            current = i;
          }
        });

        tocLinks.forEach(function(link, i) {
          if (i === current) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }

      // Remove old listener if any
      if (window._tocScrollHandler) {
        window.removeEventListener('scroll', window._tocScrollHandler);
      }
      window._tocScrollHandler = updateActive;
      window.addEventListener('scroll', updateActive, { passive: true });
      updateActive();
    }

    // Build ToC on load
    buildToc();

    /* ---- Language Switch ---- */
    function toggleLang(e) {
      e.preventDefault();
      var current = document.documentElement.getAttribute('data-lang') || 'en';
      var next = current === 'en' ? 'de' : 'en';
      document.documentElement.setAttribute('data-lang', next);
      document.getElementById('lang-toggle').textContent = next === 'en' ? 'DE' : 'EN';
      localStorage.setItem('lang', next);

      // Rebuild ToC after language switch (small delay for CSS to hide/show elements)
      setTimeout(buildToc, 50);
    }

    // Restore preference
    var saved = localStorage.getItem('lang') || 'en';
    document.documentElement.setAttribute('data-lang', saved);
    document.getElementById('lang-toggle').textContent = saved === 'en' ? 'DE' : 'EN';

    // Rebuild ToC after language restore
    setTimeout(buildToc, 50);
  </script>

</body>
</html>
